// Prof. Johnson's SecretKeeper 
// POCTF 2024 - Exploit 400
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <signal.h>
#include <string.h>

void sig_handler(int signum) {
	printf("Timeout\n");
	exit(0);
}

void init() {
	alarm(60);
	signal(SIGALRM, sig_handler);
	setvbuf(stdin, NULL, _IONBF, 0);
	setvbuf(stdout, NULL, _IONBF, 0);
	setvbuf(stderr, NULL, _IONBF, 0);
	chdir(getenv("HOME"));
}

int get_int() {
	int i;
	scanf("%d", &i);
	while (getchar() != '\n');
	return i;
}

void get_string(char *s, int len) {
	int i;
	char c;
	for (i=0; i<len&&(c=getchar())!='\n'; i++)
		s[i] = c;
	s[i] = '\0';
}

int main() {
	setvbuf(stdout, NULL, _IONBF, 0);
	char *notes[16] = {0}, *filename;
	int choice, tmp, i, size;

	init();

	printf("SecretKeeper v1.33.7 - I keep your secrets.\n\n");

	while (1) {

		printf("Speak to me your secrets, master. I am here to share your burden:\n");
		printf(" (1) I have a new secret\n (2) Release my secret to the void\n (3) Prepare to recieve my secrets\n (4) Recite my secret to me\n\n");
		printf("Choice: ");
		choice = get_int();

		switch(choice) {

			case 1:	// New
				for (i=0; i<16 && notes[i]; i++);
				if (i < 16) {
					printf("How large is your secret: ");
					size = get_int();
					notes[i] = malloc(size);
					printf("Speak your secret: ");
					get_string(notes[i], size+1);		
					printf("Your secret is safe with me, master. (ID#%d)\n\n", i);
				} else {
					printf("Master, the burden is too great. I cannot take more secrets.\n\n");
				}
				break;

			case 2: // Delete
				printf("Which secret would you like to release into the void? (ID#): ");
				choice = get_int();
				if (choice >= 0 && choice < 16 && notes[choice] != NULL) {
					free(notes[choice]);
					notes[choice] = NULL;
				} else
					printf("I do not have that secret, master.\n\n");
				break;

			case 3: // Setup filename (<category><level>_<safe/flag/hint>.txt)
				filename = strdup("Exploit400_safe.txt");
				printf("Your secrets are safe, master.\n\n");
				break;

			case 4: // Read file
				printf("I speak your secret, master: %s", filename);
				execl("/usr/bin/cat", "/usr/bin/cat", filename, NULL);
				break;
				
			default:
				printf("Invalid choice\n\n");
		}
	}
	return 0;
}

/*
                                 .$$$b                     ...                
                                4$$$$be...                  9$b               
                              id$$$$$$$$$$$$$e    .h$$$$$$$$$$$               
                           J$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$c             
                     d$- g$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$.           
                    $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$L          
                    $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$.         
                    $$$$$$$$$$$K$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$b 4       
                    4$$$$$$$$$$O""   '$$F$**$$$$$$$$$$$$$$**$$$$$$$$$L.F      
                    $$$$$$$$$$F .     ^""    ^*$$$$$*     /e$$J*$$$$$$$,      
                   4$$$$$$$$$$$$                *-"              $$$$$        
                   $$$$$$$I           d$$b             d$$c       $$$$        
                   $$$$$$$          .$"  ^                "L    $$$$$F        
                $.d$$$$$$F .        H                      ^F    "*$$\        
                *$$$$$$$$$e$       $                        ^c     $$.fF      
                 "$$$$$$$$$$"    ."   4  .                      e 4$$$G       
                   ^$$$$$$"        ^r J  $               d .f   '$$E          
                    *$$$$$       k.c$$$*$L.F          4$$$$$ b   '$"          
                     $$$$$$. l$.  m$$$$  'D          $$$$F n$"   $#.          
                      *$$$$$$$$b  $$$     4         .$$$F   'F4$$$e$          
                   .. 4$$$$$$$$C  $""     4         d$LN     F^$$$$F          
                    $$$$$$$$$$"   4.      $         ^.      d" o$$#           
                    ^"$$$$$ *      $e...a$"          *c    $$   L4F           
                      4G$ $ 4       ""$"F^            "**H"-    $ $           
                      4r4$#.F                    Y              $ $           
                       $be$*$e                                .$Ld(           
                        ^    *$.               4$$F          JU**"            
                              .$*$$bec.  ...Z$$$$$D$$$bee$$**@                
                             d"                 ""            ^*c             
                            d                                    "c           
                           $                                       "e.        
                          J"            ..       ....   $            "b       
                          $          d$$$$$$$  e$$$$$$b$*$.            *c     
                         4"         d$$$$$$$$$$$$$$$$$$$  "$c           ^$    
                         $      4$@ $$$$$$$$$$$$$$$$$$$$    ^"b.          b   
                        JF      $L  $$$$$$$$$$$$$$$$$$$F       ^$e..Y      b  
                       4$      J"*k ^$$$$$$$$$$$$$$$$$I           ^E       4  
                      .$      ^M  *b 4$$$$$$$$$$$$$$$F           .F        R  
                     .@       d"   $$$$$$$$$$$$$$$$$$            J        J"  
                    W$"      JF     $$$$$$$$$$$$$$$$$           $        .)   
                   J*       -$       $$$$$$$$$$$$$$$$r         d"       d    
                  dF       .$         $$$$$$$$$$$$$$$$$c.     J#       d"     
                 $"        $"         $$$$$$$$$$$$$$$$$K*$e$$$&      VL       
                d"        $          d$$$$$$$$$$$$$$**"   ^$r^r    e"         
               4F       .$          d$$$$$$$$$$$$$$$$r      pr4..$"           
              J$       4$"        .$$$$$$$$$$$$$$$$$$$$      $ $"             
          .$$$$b.     J$         :$$$$$$$$$$$$$$$$$$$$G.de.Ud$ $              
     ..eue$$$$$(*   T$"         .$$$$$$$$$$$$$$$$$$$$$$$$$$$C$ $              
  S$Q*""""    $$ $d$*           $$$$$$$$$$$$$$$$$$$$$$$$$$$$$"JF              
d$$  $$*"     $$ $"            :$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$"               
^$A  ^#*$$- .$"q $             $$$$$$$$$$$$$$$$$$$$$$$$$$$$$E                 
$$$$eb Reee$$$$F4F             $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$L  4$.           
^ ""#$$""   *$$$"              $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$b           
    *"                         $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$M           
                               $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$            
                          4F  4$$$$$$$$$$$$$$$$$$"4$"""""  $$$$N"             
                          $$$$$$$$$$$$C"*$$$$*"   4"    .. $                  
                          '$$$$$$$$$$F            4$$$e$ r$W                  
                           s$$$$$$$$"             4$$$$$.d$F                  
                            ^*$$*"*!              J       .                   
                                   b              F       $                   
                                   *.             F      4F                   
                                    $                    J                    
                                     b           4       L                    
                                     4b          $      J-                    
                                      $          #     .F                     
                                     $"         d      $                      
                                    $"         :F      F                      
                                   $          .$      4-                      
                                  d"          d"      j                       
                                 4O          d"       $                       
                                <$          d"        $                       
                                d          J$         $                       
                                $         4$$        4F                       
                               4F        4" $        4                        
                               $        :#  $        L                        
                               $       4O   *        F                        
                              4F      4F    4r      d                         
                              $      4*      $      $                         
                              G     d"       $     4F                         
                             4"    d         4     J                          
                             $    J          4    .F                          
                             $   4           J    4                          
                            d"  .$           F    $                           
                           dF   V           d"    F                           
                          J$               $$     F                           
                         dS    J           $$b    L                           
                        4S    ^F           $$$$F  *        
                       .$    .$            $$$$$$edF                 
                       4$$c.d$"                $$$$$r                         
                       4$$$$$"                  "**$L
*/